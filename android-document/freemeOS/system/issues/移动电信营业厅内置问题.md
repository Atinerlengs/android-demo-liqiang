[TOC]

# 需求描述

1. 在系统中内置手机营业厅
2. 该应用可以被卸载
3. 该应用可以被升级
4. 该应用应能持续运行，不可被第三方软件杀死


# 当前解决方法

## 方法1. 添加persistant属性


### 代码修改

1. 修改PMS的getPersistentApplications方法，将10086的ApplicationInfo增加FLAG_PERSISTENT，并加入“finalList”，可以让10086保持开机自启动

2. 修改AMS的addAppLocked方法，将属于10086的ProcessRecord增加persistent属性，并提高adj至PERSISTENT_PROC_ADJ

3. 修改AMS的newProcessRecordLocked方法，将属于10086的ProcessRecord增加persistent属性

以上修改提交于：

    [http://10.20.40.17:8080/#/c/10996/](http://10.20.40.17:8080/#/c/10996/)

### 遇到问题

1. 卸载移动营业厅后，不停弹出“手机营业厅”已经停止
2. 升级移动营业厅后，同样提示“手机营业厅”已经停止

通过修改AMS、PMS 强行给非System App添加persistent属性的风险很大，即使解决上述“停止运行”问题也不能保证不会有其他问题产生，所以此方法不可行！

## 方法2. 拆分需求点，各个击破

### 代码修改
1. 防止系统自己清理。通过自定义的FreemeCustomizedOom将10086的oom adj调整至PERSISTENT_PROC_ADJ

    该修改提交于：

    [http://10.20.40.17:8080/#/c/10854/](http://10.20.40.17:8080/#/c/10854/)

    [http://10.20.40.17:8080/#/c/10852/](http://10.20.40.17:8080/#/c/10852/)

    只是提高进程adj等级只能确保该进程不会被system_server主动查杀，但不能避免被第三方管家类软件进行强制清理

2. 保持开机自启。参考方法1中PMS修改开机自启部分，即加入“finalList”即可

3. 防止“一键清理”。断点调试追踪“腾讯手机管家”进行“一键优化”时调用的系统API，发现最终是间接通过“system_sever”调用的forceStopPackage，在该方法中进行判断拦截；

    该修改提交于：

    [http://10.20.40.17:8080/#/c/10997/](http://10.20.40.17:8080/#/c/10997/)

    [http://10.20.40.17:8080/#/c/11512/](http://10.20.40.17:8080/#/c/11512/)

    [http://10.20.40.17:8080/#/c/11528/](http://10.20.40.17:8080/#/c/11528/)

方法2通过拦截forceStopPackage保证不被强杀的思路替换方法1利用persistent属性被杀后自启动的思路避免了“停止运行”等问题，其他需求也可以逐一满足。至于腾讯手机管家能“借用”system_server强杀，应该是与MTK合作，使用了MTK提供的特殊接口实现。

## 其他方法

