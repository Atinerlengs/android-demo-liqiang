# 关于OTA包损坏导致无法升级的问题调查

### 0x01事故回顾

##### 问题项目状态

WF5领歌项目已量产，客户已出货10K+数量手机，该批手机内置ROM版本为 `V3.08` 。

#####  客户需求

客户要求提供之前版本到该版本 `V3.08` 的升级包，同时后续提供基于该版本的OTA升级包。

##### 出现问题

针对客户需求，从升级包服务器下载 `V3.08` 版本，制作升级包时提示文件内部出错（即文件损坏），无法生成升级包，由于时间较久， `V3.08` 版本原文件已删除。

##### 潜在风险

如不能复原 `V3.08` 版本，则无法制作该版本到后续版本的升级包！
如果不能解决该问题，该批10多K烧录该版本的机器将无法完成任何OTA升级，只能返厂烧录新版本ROM。
这个代价很大，很可能导致客户对我们的升级方案失去信心，后续替换为其他公司的升级方案，最终失去客户。

### 0x02 现象剖析

梳理了下目前软件OTA制作上传下载流程，如下：

![](res/6.svg)

上述流程可见， **如服务器文件出错，则基于该版本后续升级全会失败** ；而导致文件出错原因可能有如下几种：

- 人工上传时出错
- 服务器硬件故障，如异常断电导致数据丢失、硬盘老化等导致的数据失效
- 其他潜在风险，如软件包误删除等

总结下，即上述流程的问题在于以下两点：

- 数据包存储缺少相应校验检查机制和容错机制
- 过多的人工操作，而人工操作很容易出现疏漏，风险很高

针对以上两点，可能的解决方案：

- 当前数据服务器使用ftp，该服务器已经多次出现数据包损坏情况，对该服务器硬件检修维护、上传数据包时同时提供校验机制，此外，可以添加一台备份服务器做同步备份。
- 引入持续集成方案，减少人为干预：将拉取代码节点、编译、包检查以及上传服务器的操作使用程序化自动完成。减少人为失误风险。

### 0x03 临时解决方案

##### 复现现象
下载服务器备份文件，使用OTA命令制作差分包，出现基本版包 *CRC校验* 错误（如下）

```shell
chenming@ChenM: ~/workspace/RomSourceCode/6737M_65_M0_GMO/freemeos_dev$ ./otaTrue full_wf562g_leagoo-target_files-1478272041.zip full_wf562g_leagoo-target_files-1479453737.zip 
unzipping target target-files...
/tmp/targetfiles-zNCJFC/SYSTEM/framework/arm/boot.oat  bad CRC d6fc6d2a  (should be 498c17bc)

   ERROR: failed to unzip input target-files "full_wf562g_leagoo-target_files-1479453737.zip"

chenming@ChenM: ~/workspace/RomSourceCode/6737M_65_M0_GMO/freemeos_dev$
```

> CRC校验：通过校验码，验证文件完整性
>
> OTA原理：基于full-A 包与 full-B 包，产生 A->B 的升级包， 如full A 出错，则所有使用A版本的机器无法升级

查看OTA脚本，发现出错原因由于执行```unzip -o -q *.zip -d outdir ```命令（解压zip文件）导致；手动执行该命令，依然出现上述问题，确认zip文件出错；

##### 复原损坏文件

解压包，确认 `boot.oat` 已损坏

升级包中的还存储了系统镜像文件，且该文件中也保存了一份 `boot.ota` 文件，取出该文件后确认该文件正常！利用该文件重新生成升级包，并利用该包重新制作差分包，执行OTA升级，测试无问题。

### 0x04 结语

虽然最终我们解决这次事故，但不得不说有非常大的运气成分。如果基础包中没有存储镜像文件，或者该包彻底损坏无法解压，甚至该包被误删除？我们该如何面对当前的局面？

升级包属于重要的生产资料，而这次发生升级包损坏，暴露出我们对生产资料管理维护上有很大漏洞。这次损坏的只是一个升级包，如果下次损坏的是整个存储服务器呢？

请大家考虑下这个问题。
